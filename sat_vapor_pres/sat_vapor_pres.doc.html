<HTML>
<HEAD>
<TITLE>module sat_vapor_pres</TITLE>
<!-- LINK REL=stylesheet HREF="http://www.gfdl.noaa.gov/~fms/style/fms.css" -->
</HEAD>
<BODY BGCOLOR="#AABBCC" TEXT="#332211">

<DIV ALIGN="CENTER"> <FONT SIZE=-2>
<A HREF="#PUBLIC INTERFACE">PUBLIC INTERFACE</A> / 
<A HREF="#PUBLIC ROUTINES">ROUTINES</A> / 
<A HREF="#CHANGE HISTORY">CHANGES</A> / 
<A HREF="#ERROR MESSAGES">ERRORS</A> / 
<A HREF="#NOTES">NOTES</A> 
</FONT>
<BR></DIV><HR>


<H2>module sat_vapor_pres</H2>
<A NAME="HEADER">
<PRE>

     <B>Contact:</B>   Bruce Wyman
     <B>Reviewers:</B>

     <B><A HREF=".doc.log#sat_vapor_pres.f90">Tags/Status</A>
</PRE>
</A><!-- END HEADER -->
<!--------------------------------------------------------------------->
<A NAME="OVERVIEW">
<HR>
<H4>OVERVIEW</H4>
<!-- BEGIN OVERVIEW -->
<PRE>

Routines for determining the saturation vapor pressure (ES) and
the derivative of ES with respect to temperature.

</PRE>
</A><!-- END OVERVIEW -->
<!--------------------------------------------------------------------->
<A NAME="DESCRIPTION">
<!-- BEGIN DESCRIPTION -->
<PRE>
This module contains routines for determining the saturation vapor
pressure (ES) from lookup tables constructed using equations given
in the Smithsonian tables.  The ES lookup tables are valid between
-160C and +100C (approx 113K to 373K).

The values of ES are computed over ice from -160C to -20C,
over water from 0C to 100C, and a blended value (over water and ice)
from -20C to 0C.

This version was written for non-vector machines.
See the <A HREF="sat_vapor_pres.doc.html#NOTES">notes section</a> for details on vectorization.

</PRE>
</A><!-- END DESCRIPTION -->
<!--------------------------------------------------------------------->
<A NAME="OTHER MODULES USED">
<HR>
<H4>OTHER MODULES USED</H4>
<!-- BEGIN OTHER MODULES USED -->
<PRE>

    utilities_mod
    constants_mod

</PRE>
</A><!-- END OTHER MODULES USED -->
<!--------------------------------------------------------------------->
<A NAME="PUBLIC INTERFACE">
<HR>
<H4>PUBLIC INTERFACE</H4>
<!-- BEGIN PUBLIC INTERFACE -->
<PRE>

     <b>use sat_vapor_pres_mod</b> [, only: escomp,
                                     descomp,
                                     compute_es,
                                     sat_vapor_pres_init ]

     <a href="sat_vapor_pres.doc.html#escomp">escomp</a>
          For the given temperatures, returns the saturation vapor pressures.

     <a href="sat_vapor_pres.doc.html#escomp">descomp</a>
          For the given temperatures, returns the derivative of
          saturation vapor pressure with respect to temperature.

     <a href="sat_vapor_pres.doc.html#compute_es">compute_es</a>
          For the given temperatures, computes the saturation vapor pressures.

     <a href="sat_vapor_pres.doc.html#sat_vapor_pres_init">sat_vapor_pres_init</a>
          Initializes the lookup tables for saturation vapor pressure.

</PRE>
</A><!-- END PUBLIC INTERFACE -->
<!--------------------------------------------------------------------->
<A NAME="PUBLIC ROUTINES">
<HR>
<H4>PUBLIC ROUTINES</H4>
<!-- BEGIN PUBLIC ROUTINES -->
<a name="escomp">
<PRE>
<b>call escomp</b>  ( temp, esat )
<b>call descomp</b> ( temp, desat )

DESCRIPTION
   For the given temperatures these routines return the
   saturation vapor pressure (esat) or the derivative of esat w.r.t.
   temperature (desat). The return values are derived from
   lookup tables (see notes below).

INPUT
   temp       Temperature in degrees Kelvin.
              May be a scalar, 1d, 2d, or 3d array.
              <FONT SIZE=-1 COLOR="#000099">[real]</FONT>

OUTPUT
   esat       Saturation vapor pressure in pascals.
              May be a scalar, 1d, 2d, or 3d array.
              Must have the same order and size as temp.
              <FONT SIZE=-1 COLOR="#000099">[real]</FONT>

   desat      Derivative of saturation vapor pressure w.r.t. temperature
              in pascals/degree. May be a scalar, 1d, 2d, or 3d array.
              Must have the same order and size as temp.
              <FONT SIZE=-1 COLOR="#000099">[real]</FONT>
</PRE>

<!------------------------>
<HR WIDTH="50%" ALIGN=LEFT>
<a name="compute_es">
<PRE>
esat = <b>compute_es</b> ( temp )

DESCRIPTION
   Computes saturation vapor pressure for the given temperature using
   the equations given in the Smithsonian Meteorological Tables.
   Between -20C and 0C a blended value over ice and water is returned.

INPUT
   temp       Temperature in degrees Kelvin.
              May be a scalar, 1d, 2d, or 3d array.
              <FONT SIZE=-1 COLOR="#000099">[real]</FONT>

RETURNS
   esat       Saturation vapor pressure in pascals.
              May be a scalar, 1d, 2d, or 3d array.
              Must have the same order and size as temp.
              <FONT SIZE=-1 COLOR="#000099">[real]</FONT>
</PRE>

<!------------------------>
<HR WIDTH="50%" ALIGN=LEFT>
<a name="sat_vapor_pres_init">

<PRE>
<b>call sat_vapor_pres_init</b>

DESCRIPTION
   Initializes the lookup tables for saturation vapor pressure.
   This routine will be called automatically the first time
   <b>escomp</b> or <b>descomp</b> is called,
   the user does not need to call this routine.
   There are no arguments.

</PRE>

</A><!-- END PUBLIC ROUTINES -->
<!--------------------------------------------------------------------->
<A NAME="CHANGE HISTORY">
<HR>
<H4>CHANGES</H4>
<!-- BEGIN CHANGE HISTORY -->
<PRE>
<B><A HREF="http://www.gfdl.gov/pjk-cgi-bin/cvsweb.cgi/FMS/shared
/sat_vapor_pres/sat_vapor_pres.f90?cvsroot=/home/fms/cvs">CVS revision history for sat_vapor_pres.f90</A></B>
</PRE>
</A><!-- END CHANGE HISTORY -->
<!--------------------------------------------------------------------->
<A NAME="ERROR MESSAGES">
<HR>
<H4>ERROR MESSAGES</H4>
<!-- BEGIN ERROR MESSAGES -->
<PRE>

<b>FATAL errors in sat_vapor_pres_mod</b>

    table overflow, nbad=##
        <FONT SIZE=-1>Temperature(s) provided to the saturation vapor pressure lookup
          are outside the valid range of the lookup table (-160 to 100 deg C).
          This may be due to a numerical instability in the model.
          Information should have been printed to standard output to help
          determine where the instability may have occurred.
          If the lookup table needs a larger temperature range,
          then parameters in the module header must be modified.

</PRE>
</A><!-- END ERROR MESSAGES -->
<!--------------------------------------------------------------------->
<A NAME="KNOWN BUGS">
<HR>
<H4>KNOWN BUGS</H4>
<!-- BEGIN KNOWN BUGS -->
<PRE>

    No error checking is done to make sure that the size of the
    input and output fields match.

</PRE>
</A><!-- END KNOWN BUGS -->
<!--------------------------------------------------------------------->
<A NAME="NOTES">
<HR>
<H4>NOTES</H4>
<!-- BEGIN NOTES -->
<PRE>

VECTORIZATION

    To create a vector version the lookup routines need to be modified.
    The local variables: tmp, del, ind, should be changed to arrays
    with the same size and order as input array temp.
   

CONSTRUCTION OF THE ES TABLES

    The tables are constructed using the saturation vapor pressure (ES)
    equations in the Smithsonian tables. The tables are valid between
    -160C to +100C with increments at 1/10 degree. Between -160C and -20C
    values of ES over ice are used, between 0C and 100C values of ES
    over water are used, between -20C and 0C blended values of ES
    (over water and over ice) are used.

    There are three tables constructed: ES, first derivative (ES'), and
    second derivative (ES'').  The ES table is constructed directly from 
    the equations in the Smithsonian tables. The ES' table is constructed
    by bracketing temperature values at +/- 0.01 degrees. The ES'' table
    is estimated by using centered differencing of the ES' table.

DETERMINATION OF es AND es' FROM LOOKUP TABLES

    Values of the saturation vapor pressure (es) and the derivative (es')
    are determined at temperature (T) from the lookup tables (ES, ES', ES'')
    using the following formula.

    es (T) = ES(t) + ES'(t) * dt + 0.5 * ES''(t) * dt**2
    es'(T) = ES'(t) + ES''(t) * dt

    where     t = lookup table temperature closest to T
             dt = T - t

INTERNAL (PRIVATE) PARAMETERS

    These parameters can be modified to increase/decrease the size/range
    of the lookup tables.

    tcmin   The minimum temperature (in deg C) in the lookup tables.
              [integer, default: tcmin = -160]

    tcmax   The maximum temperature (in deg C) in the lookup tables.
              [integer, default: tcmin = +100]
    

</PRE>
</A><!-- END NOTES -->
<!--------------------------------------------------------------------->
<A NAME="REFERENCES">
<HR>
<H4>REFERENCES</H4>
<!-- BEGIN REFERENCES -->
<PRE>

    Smithsonian Meteorological Tables
    Page 350

</PRE>
</A><!-- END REFERENCES -->
<!--------------------------------------------------------------------->
<A NAME="FUTURE PLANS">
<HR>
<H4>FUTURE PLANS</H4>
<!-- BEGIN FUTURE PLANS -->
<PRE>

    None.

</PRE>
</A><!-- END FUTURE PLANS -->
<!--------------------------------------------------------------------->
<A NAME="TEST PROGRAM">
<HR>
<H4>TEST PROGRAM</H4>
<!-- BEGIN TEST PROGRAM -->
<PRE>
program test_sat_vapor_pres
use sat_vapor_pres_mod
implicit none

integer, parameter :: ipts=500, jpts=100, kpts=50, nloop=1
real, dimension(ipts,jpts,kpts) :: t,es,esn,des,desn
integer :: n

! generate temperatures between 120K and 340K
  call random_number (t)
  t = 130. + t * 200.

! initialize the tables (optional)
  call sat_vapor_pres_init

! compute actual es and "almost" actual des
   es = compute_es  (t)
  des = compute_des (t)

do n = 1, nloop
! es and des
  call  escomp (t, esn)
  call descomp (t,desn)
enddo

! terminate, print deviation from actual
  print *, 'size=',ipts,jpts,kpts,nloop
  print *, 'err es  = ', sum((esn-es)**2)
  print *, 'err des = ', sum((desn-des)**2)

contains

!----------------------------------
! routine to estimate derivative

 function compute_des (tem) result (des) 
 real, intent(in) :: tem(:,:,:)
 real, dimension(size(tem,1),size(tem,2),size(tem,3)) :: des,esp,esm
 real, parameter :: tdel = .01
    esp = compute_es (tem+tdel)
    esm = compute_es (tem-tdel)
    des = (esp-esm)/(2*tdel)
 end function compute_des
!----------------------------------

end program test_sat_vapor_pres

</PRE>
</A><!-- END TEST PROGRAM -->
<!--------------------------------------------------------------------->

<HR>
</BODY>
</HTML>
